# 结合任务切换功能

时间：2024/7/20

已有的任务调度功能负责任务的管理和调度，也就是，负责任务数据结构的保存和移动。其需要结合的学长的工作有以下两点：任务切换，以及任务数据结构。

## 任务切换功能

学长编写的任务切换机制具有`preempt_switch_entry`和`switch_entry`两个入口。

```  
           [进入switch_entry函数]     [进入preempt_switch_entry函数]
                    |                             |
                    v                             v
                获取当前任务                   获取当前任务     【两处都需要结合我写的当前任务】
                    |                             |
                    v                             |
    --------切换对象为线程还是协程                  |
    |               |                             |
    |             线程                            |
    |               |                             |
    |               v                             v
    |       保存当前任务上下文（此处是上下文恢复后的执行点） 
    |                               |
   协程                             v
    |               [进入schedule_with_sp_change函数]
    |                               |
    |                               v
    |                             更换栈
    |                               |
    |                               v
    -------------->[进入schedule_without_sp_change函数]<-------------------------------------
                                    |                                                       |
                                    v                                                       |
                从调度器取出下一任务【需要结合我写的调度器】                                    |
                                    |                                                       |
                                    v                                                       |
                再获取一次当前任务【需要结合我写的当前任务】                                    |
                                    |                                                       |
                                    v                                                       |
读取当前任务状态，根据状态处理当前任务（可能放回调度器【需要结合我写的调度器】），修改任务状态       |
                                    |                                                       |
                                    v                                                       |
                将当前任务设置为新任务【需要结合我写的当前任务】                                |
                                    |                                                       |
                                    v                                                       |
                            [进入run_next函数]                                               |
                                    |                                                       |
                                    v                                                       |
                    --------下一任务为线程还是协程？--------                                  |
                    |                                    |                                  |
                   线程                                 协程                                 |
                    |                                    |                                  |
                    v                                    v                                  |
            恢复栈、恢复上下文                       poll一次future----------------------------
```

任务切换引入的其它内容：

1. 任务数据结构、任务上下文相关操作（`taskctx`模块）
2. 当前栈及相关操作（`axtask/task_switch.rs`内部）
3. 当前处理器数据：`stack_pool`、`idle_task`？、GC相关内容？（`axtask/processor.rs, stack_pool.rs`）
4. 时间相关内容（可以暂时不管？）
5. 协程相关内容（如`Waker`）（`axtask/waker.rs`）

## 以Async-Starry为例，考虑任务调度功能与其它任务管理功能的接口

### axtask模块

（任务相关）依赖项：`timer_list`、`taskctx`、`scheduler`

功能：

1. 任务相关：定义AxTask类型，与调度器有关、创建、设置优先级、让出、睡眠、唤醒、退出（`api.rs`、`task.rs`）、协程的Waker（`waker.rs`）
2. 当前任务相关操作：获取、
3. 调度器相关操作：在每个CPU核心上的初始化（`processor.rs`）、获取下一任务、放回上一任务、加入任务、每个tick的行为
4. 中断相关操作：暂时不考虑
5. 处理器：相关内容：调度器、退出队列、上个任务保存的上下文、栈池、空闲任务、gc任务；相关操作：退出任务的回收、所属调度器的各种行为、上下文保存、获取栈、切换栈、获取当前处理器（`processor.rs`）
6. 栈相关：获取空栈、切换当前栈（`stack_pool.rs`）
7. 任务切换机制：详见上文（`task_switch.rs`）
8. 定时器相关：暂时不考虑
9. 阻塞队列：阻塞当前任务、唤醒队列中的任务（`wait_list.rs`、`wait_queue.rs`）

### timer_list模块

暂时不考虑

### taskctx模块

功能：

1. 当前任务指针：获取、设置（`current.rs`）
2. 计时相关：暂时不考虑
3. TaskInner结构：描述上下文、是否可抢占、页表token等资源（`task.rs`）
4. tls相关：暂时不考虑

### schedluer模块

功能：

1. 定义各种调度器：初始化、加入任务、删除任务、取出下一任务、放回上一任务、每个tick的动作

## 需要移植的功能：

1. 任务的定义：使用AxTask，其分为TaskInner、TaskState、Processor（任务在哪个处理器上运行）三部分，并会在Scheduler处进行一次包装
2. 处理器数据结构：调度器、退出任务与gc任务、上个任务上下文的保存位置、栈池
3. 栈数据结构
4. 任务切换机制
5. 协程的waker